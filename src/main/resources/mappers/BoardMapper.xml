<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ssafy.enjoytrip.mapper.BoardMapper">

    <insert id="writeArticle" parameterType="boardDto">
        INSERT INTO board (
            user_id, title, content, hit, regist_date,
            type, content_id, rating,
            attraction_title, attraction_img,
            latitude, longitude  )
        VALUES (
                   #{userId}, #{title}, #{content}, 0, now(),
                   #{type}, #{contentId}, #{rating},
                   #{attractionTitle}, #{attractionImg},
                   #{latitude}, #{longitude} )
    </insert>

    <select id="listArticle" parameterType="map" resultType="boardDto">
        SELECT 
            b.board_id, b.user_id, b.title, b.content, b.rating, b.hit, b.like_count, b.regist_date,
            b.type, b.save_file,
            u.nickname,
            a.title AS attractionTitle,
            a.first_image AS attractionImg,
            
            (SELECT COUNT(*) FROM comments c WHERE c.board_id = b.board_id AND c.is_deleted = 0) AS commentCount
            
        FROM board b
        LEFT JOIN user u ON b.user_id = u.user_id
        LEFT JOIN attractions a ON b.content_id = a.content_id
        <where>
        	<if test="type != 0">
                AND b.type = #{type}
            </if>
            <if test="word != null and word != ''">
                AND b.title LIKE CONCAT('%', #{word}, '%')
            </if>
        </where>
        ORDER BY b.board_id DESC
    </select>

    <select id="getArticle" parameterType="int" resultType="boardDto">
        SELECT 
            b.board_id,
            b.user_id as userId,
            b.title,
            b.content,
            b.rating,
            b.hit,
            b.like_count,
            b.regist_date,
            b.type,
            b.save_file,
            b.original_file,
            b.content_id,
            u.nickname,
            
            (SELECT COUNT(*) FROM comments c WHERE c.board_id = b.board_id AND c.is_deleted = 0) AS commentCount
            
        FROM board b
        LEFT JOIN user u ON b.user_id = u.user_id
        WHERE b.board_id = #{boardId}
    </select>
    
    <update id="updateHit" parameterType="int">
        UPDATE board SET hit = hit + 1 WHERE board_id = #{boardId}
    </update>
    
    <update id="modifyArticle" parameterType="boardDto">
    	UPDATE board
    	SET title = #{title},
    		content = #{content},
    		rating = #{rating}
    		<if test="originalFile != null and originalFile != ''">
    			, original_file = #{originalFile}
    			, save_file = #{saveFile}
    		</if>
    	WHERE board_id = #{boardId}
    </update>
    
    <delete id="deleteArticle" parameterType="int">
    	DELETE FROM board WHERE board_id = #{boardId}
    </delete>
    
	<select id="getReviewStats" parameterType="int" resultType="map">
	  SELECT
	    COUNT(*) AS reviewCount,
	    ROUND(AVG(rating), 1) AS avgRating
	  FROM board
	  WHERE type = 2
	    AND content_id = #{contentId}
	</select>

    <select id="listMyArticle" parameterType="string" resultType="boardDto">
        SELECT
            b.board_id,
            b.content_id, b.title,
            b.hit,
            b.like_count,
            b.regist_date,
            b.type,
            b.attraction_title,
            b.latitude,
            b.longitude,
            
            (SELECT COUNT(*) FROM comments c WHERE c.board_id = b.board_id AND c.is_deleted = 0) AS commentCount
            
        FROM board b
        WHERE b.user_id = #{userId}
        ORDER BY b.board_id DESC
    </select>
</mapper>